<!DOCTYPE html>
<html>
<head>
	<title>Animator</title>
        <link type="text/css" rel="stylesheet" href="webapp.css">
	<style type="text/css">

#canvas {
 cursor: crosshair;
}

	</style>
	<script>

// keys
var keys = {
	n: false,
	m: false,
        d: false,
        s: false,
        a: false
};


window.onload = function() {




//										settings

var ost = 50;
var frameTimer = 3;




//										setup

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
ctx.fillStyle = "white";
ctx.fillRect(0, 0, canvas.width, canvas.height);

var animator = 
	window.requestAnimationFrame ||
	window.msRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.webkitRequestAnimationFrame;




//      variables

// mouse
var mouseX = 0, mouseY = 0, mouseDown = false, mouseOver = false;

// crayon pattern
var crayonImg = new Image();
crayonImg.src = "https://raw.githubusercontent.com/thomasm1248/thomasm1248.github.io/master/webapps/media/black_crayon.png";
var crayon = ctx.createPattern(crayonImg, "repeat");




//	util functions

function line(x1, y1, x2, y2) {
	ctx.beginPath();
	ctx.moveTo(x1, y1);
	ctx.lineTo(x2, y2);
	ctx.strokeStyle = crayon;
        ctx.lineWidth = 3;
	ctx.stroke();
}

function onionSkin() {
        ctx.globalAlpha = ost / 100;
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
}




//	objects

// states
var Playing, Animating;
var state;




//	Animating

Animating = function(movie, stack) {
	this.movie = movie;
        this.stack = stack;
	this.start = true;
	this.drawing = false;
	this.px = 0;
	this.py = 0;




	// methods

	this.draw = function() {
		if(this.drawing && mouseDown) {
			line(this.px, this.py, mouseX, mouseY);
			this.movie[this.movie.length - 1].push([this.px, this.py, mouseX, mouseY]);
		} else if(this.drawing) {
			this.drawing = false;
		} else if(mouseDown) {
			this.drawing = true;
		}
	}

	this.updateMouse = function() {
		this.px = mouseX;
		this.py = mouseY;
	}

        this.drawFrame = function(frame) {
                for(var i = 0; i < frame.length; i++) {
                        line(
                            frame[i][0],
                            frame[i][1],
                            frame[i][2],
                            frame[i][3]
                        );
                }
        }

        this.updateDisplay = function() {
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                this.drawFrame(this.movie[this.movie.length - 2]);
                onionSkin();
                this.drawFrame(this.movie[this.movie.length - 1]);
        }

	this.control = function() {
		if(keys.m) {
			keys.m = false;

			state = new Playing(this.movie, this.stack);
		} else if(keys.n) {
			keys.n = false;

			this.movie.push([]);
			onionSkin();
		} else if(keys.d) {
                        this.stack.push(this.movie[this.movie.length - 1]);
                        keys.d = false;
                } else if(keys.s) {
                        this.movie.pop();
                        this.movie.push(
                            this.stack[this.stack.length - 1].concat([]).slice(
                                0,
                                -1
                            )
                        );
                        this.updateDisplay();
                        keys.s = false;
                } else if(keys.a) {
                        this.stack.pop();
                        keys.a = false;
                }
	}

	this.update = function() {
		this.draw();
		this.control();
		this.updateMouse();
	}
}

//		Playing

Playing = function(movie, stack) {
	this.movie = movie;
        this.stack = stack;
	this.frameNum = 0;
	this.timer = frameTimer;




	// methods

	this.background = function() {
		ctx.fillStyle = "white";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
	}

	this.drawFrame = function() {
		var thisFrame = this.movie[this.frameNum];

		for(var i = 0; i < thisFrame.length; i++) {
			line(thisFrame[i][0], thisFrame[i][1], thisFrame[i][2], thisFrame[i][3])
		}
	}

	this.update = function() {
		if(this.timer === 0) {
			this.background();
			this.drawFrame();

			this.frameNum++;
			if(this.frameNum >= this.movie.length) {
                                this.frameNum -= 2;
                                this.drawFrame();
                                onionSkin();
                                this.frameNum++;
                                this.drawFrame();
				state = new Animating(this.movie, this.stack);
			}

			this.timer = frameTimer;
		}
		
		this.timer--;
	}
}




//										draw function

state = new Animating([[]], []);

function draw() {
	state.update();

	animator(draw);
}




//										events

canvas.addEventListener("mousemove", ifMouseMove, false);
canvas.addEventListener("mousedown", ifMouseDown, false);
canvas.addEventListener("mouseup", ifMouseUp, false);
window.addEventListener("keydown", ifKeyDown, false);
window.addEventListener("keyup", ifKeyUp, false);

function ifMouseMove(e) {
	var rect = canvas.getBoundingClientRect();

	mouseX = e.clientX - rect.left;
	mouseY = e.clientY - rect.top;
}

function ifMouseDown() {
	mouseDown = true;
}

function ifMouseUp() {
	mouseDown = false;
}

function ifKeyDown(e) {
	switch(e.keyCode) {
		case 78:
			keys.n = true;
			break;
		case 77:
			keys.m = true;
			break;
                case 68:
                        keys.d = true;
                        break;
                case 83:
                        keys.s = true;
                        break;
                case 65:
                        keys.a = true;
                        break;
	}
}

function ifKeyUp(e) {
	switch(e.keyCode) {
		case 78:
			keys.n = false;
			break;
		case 77:
			keys.m = false;
			break;
                case 68:
                        keys.d = false;
                        break;
                case 83:
                        keys.s = false;
                        break;
                case 65:
                        keys.a = false;
                        break;
	}
}




//										startup

draw();




}


	</script>
	<script id="movie">var movie = [];</script>
</head>
<body>
	<canvas
			id="canvas"
			width="800"
			height="600">
		Sorry. Your browser doesn't currently support HTML5 canvas.
	</canvas><br>
        <button onclick="keys.n = true;">Next</button>
        <button onclick="keys.m = true;">Play</button>
</body>
